name: Build New Axe Version

on: 
  workflow_dispatch:
    inputs:
      old_version:
        description: 'The old axe-core version to be replaced'
        required: true
        type: string
      current_version:
        description: 'The new axe-core version to use'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  axe-dependency-check:
    name: "Axe Version Check"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Download and extract axe-core files
        run: |
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          npm install axe-core --no-save
          cp node_modules/axe-core/axe.js $GITHUB_WORKSPACE/src/pytest_playwright_axe/resources/
          cp node_modules/axe-core/axe.min.js $GITHUB_WORKSPACE/src/pytest_playwright_axe/resources/
          rm -rf "$TEMP_DIR"

      - name: Update version references
        run: |
          find . -type f \( -name "*.toml" -o -name "*.py" -o -name "*.md" \) \
            -not -path "*/node_modules/*" \
            -exec sed -i "s/${{ inputs.old_version }}/${{ inputs.current_version }}/g" {} +

      - name: Create pull request
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: axe-dependency-check-${{ inputs.current_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git add src/pytest_playwright_axe/resources/axe*.js pyproject.toml src/pytest_playwright_axe/__init__.py
          git commit -m "chore: update axe-core to ${{ inputs.current_version }}"
          git push --set-upstream origin "$BRANCH_NAME"
          
          gh pr create \
            --title "Update axe-core to ${{ inputs.current_version }}" \
            --body "Automated update of axe-core dependency from ${{ inputs.old_version }} to ${{ inputs.current_version }}." \
            --label "feature,automated pr" \
            --reviewer davethepunkyone
