name: Build New Axe Version

on: [workflow_dispatch]

jobs:
  axe-dependency-check:
    name: "Axe Version Check"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - run: |
          git checkout ${{ github.head_ref }}
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'
      - name: Install axe-core in temp dir
        run: |
          cd src/pytest_playwright_axe/resources
          mkdir temp
          cd temp
          npm install axe-core
      - name: Retrieve axe.js file
        run: |
          cd src/pytest_playwright_axe/resources/temp/node_modules/axe-core
          mv axe.js ../../../
          mv axe.min.js ../../../
      - name: Remove temp directory
        run: |
          cd src/pytest_playwright_axe/resources
          rm -rf temp
      - name: Commit to axe-dependency-check branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b axe-dependency-check
          git add src/pytest_playwright_axe/resources/axe.js
          git add src/pytest_playwright_axe/resources/axe.min.js
          git commit -m "axe-core automated update"
          git push --set-upstream origin axe-dependency-check
      - name: Create Pull Request
        uses: actions/github-script@v6
        with:
          script: |
            const { repo, owner } = context.repo;
            const result = await github.rest.pulls.create({
              title: 'Update axe-core files',
              owner,
              repo,
              head: 'axe-dependency-check',
              base: 'main',
              body: [
                'This PR is auto-generated by [actions/github-script](https://github.com/actions/github-script).',
                'It updates the axe-core dependency in the project.',
              ].join('\n')
            });
            github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: result.data.number,
              labels: ['feature', 'automated pr']
            });
            github.rest.issues.requestReviewers({
              owner,
              repo,
              pull_number: result.data.number,
              reviewers: ['davethepunkyone']
            });